var URLlink = ['twitter.com/iamctodd/status/1128098468722040832',
'twitter.com/MindShiftKQED/status/1130088299173941249',
'twitter.com/verbistheword/status/1107388945980104707',
'twitter.com/mslanei/status/1131524544395599872',
'twitter.com/sherrillknezel/status/1131989750708166656',
'twitter.com/sainiankur/status/1131206461776891904',
'twitter.com/sketching4agile/status/1122242400141942784',
'twitter.com/fero_studio/status/1042357990312095744',
'twitter.com/chrisspalton/status/1133699084701904896',
'twitter.com/chrisspalton/status/1133693071739236352',
'twitter.com/chrisspalton/status/1133665625547640832',
'twitter.com/Mappletons/status/1134513633596248064',
'twitter.com/chrisspalton/status/1133685093049020416',
'twitter.com/malweene/status/1134866239686418432',
'twitter.com/malweene/status/1134864622085988353',
'twitter.com/lisi_linhart/status/1134829409859448835',
'twitter.com/chrisnoessel/status/1134861226893283328',
'twitter.com/Rob_Dimeo/status/1121023032695382016',
'twitter.com/girlie_mac/status/1125871107876081664',
'twitter.com/imgraceeliz/status/1124340728392507392',
'twitter.com/lariki/status/1126236626361798657',
'twitter.com/ankedesign/status/1129753037457809411',
'twitter.com/axbom/status/1131233895993810944',
'twitter.com/rmnth/status/1134684201553354754',
'twitter.com/jo_heidebrecht/status/1125847359546712064',
'twitter.com/sketchnotesclub/status/1125766948082548736',
'twitter.com/Sonia_Sparkles/status/1112647344384868353',
'twitter.com/LitCoachLady/status/1114570813519355905',
'twitter.com/evalottchen/status/1135176634934407168',
'twitter.com/chrisnoessel/status/1133665911259500545',
'twitter.com/lisihocke/status/1134495949919838209',
'twitter.com/1077c43n/status/1135831527080779776',
'twitter.com/MoLewis1967/status/1132648423654453249',
'twitter.com/ElaVitikainen/status/1134408079779540992',
'twitter.com/swampmonster/status/1135976796384399360',
'twitter.com/pensaardesign/status/1135880687527968770',
'twitter.com/stephaniecodes/status/1136067563203518464',
'twitter.com/JeffSannebeck/status/1136289493705666560',
'twitter.com/nmlfonger/status/1136282409887047682',
'twitter.com/MrsLedford6Eng/status/1136279762509410304',
'twitter.com/KatjaBudnikov/status/1136299724686942209',
'twitter.com/holykamote/status/1136232218940981248',
'twitter.com/wilfredspringer/status/1134408373812768768',
'twitter.com/5aff/status/1135591208238157827',
'twitter.com/saurau/status/1136901260827910144',
'twitter.com/mrshunt120/status/1136709770407239682',
'twitter.com/TarahTesmer/status/1136982239827451905',
'twitter.com/mjbroadbent/status/1136983785612832769',
'twitter.com/LauraLaQuaglia/status/1136376770645712897',
'twitter.com/tyhatch/status/1136999421965717506',
'twitter.com/aboozershealy/status/1137705442317078529',
'twitter.com/MrsKemper/status/1137167488809144321',
'twitter.com/MarySci17/status/1137449142270267393',
'twitter.com/MsFortsKidsRock/status/1136408960188198913',
'twitter.com/erinmwaring/status/1137460983847366657',
'twitter.com/KTOY2019/status/1137398263764701189',
'twitter.com/HowardEdTech/status/1135640921100423169',
'twitter.com/HighScopeUS/status/1133845815871594503',
'twitter.com/gavin_scribes/status/1132461942801481729',
'twitter.com/chiuki/status/1126574956307857408',
'twitter.com/ryan__drago/status/1136710684467744769',
'twitter.com/PakGeena/status/1136439867674509312',
'twitter.com/Med_Utopia/status/1138092704024469505',
'twitter.com/gpmortimer/status/1136674136472920069',
'twitter.com/GrundlerArt/status/1121586772197220353',
'twitter.com/SuzeShardlow/status/1131257612694097920',
'twitter.com/degroote44/status/1118635931467227136',
'twitter.com/martigold/status/1123218094229524480',
'twitter.com/Valeriasketches/status/1137065631185088522',
'twitter.com/ramoss/status/1136753048062238720',
'twitter.com/gpmortimer/status/1138603346623946753',
'twitter.com/MarySci17/status/1138511667480993793',
'twitter.com/1077c43n/status/1138762353657503744',
'twitter.com/JonnyDaenen/status/1135633620608180224',
'twitter.com/davincidiva/status/1136366306465206272',
'twitter.com/andymcnally/status/1138846438132203521',
'twitter.com/SummitVChurch/status/1136735744117153794',
'twitter.com/hi_mischelle/status/1136328129163644928',
'twitter.com/wilfredspringer/status/1134476920303890432',
'twitter.com/matteofarinella/status/1114183251050913793',
'twitter.com/merielroyal/status/1114124559526105088',
'twitter.com/evalottchen/status/1105431352588017664',
'twitter.com/renetalk/status/1139577667869712385',
'twitter.com/MarySci17/status/1139231609436155904',
'twitter.com/zobrodesign/status/1050082042904539136',
'twitter.com/kirsty_joan/status/1139104471366164480',
'twitter.com/saurau/status/1136604106083246080',
'twitter.com/felibe444/status/1139450461310898183',
'twitter.com/pietvanzoen/status/1138718117004292096',
'twitter.com/jgough/status/1113991592669376512',
'twitter.com/rob_choudhury/status/1113818042503397378',
'twitter.com/ProfVigeant/status/1113584223464460288',
'twitter.com/lisibo/status/1109056390696501248',
'twitter.com/calexity/status/1099110287867871232',
'twitter.com/suribbles/status/1101003142693412864',
'twitter.com/katiemartinedu/status/1096415172103716867',
'twitter.com/kheiladunkerly/status/1095338710881562624',
'twitter.com/GenevieveDeBose/status/1073356538729750528',
'twitter.com/sophdex/status/1062369950566961152',
'twitter.com/annalena/status/1059025705877540865',
'twitter.com/JamesDykman/status/1056492449432973313',
'twitter.com/DrGenever/status/1040198869915713538',
'twitter.com/pritchardmr/status/1038006079026868224']

console.log('COUCOU')
var data_ = []; 
var idArray = {};
var globalArray = {};
var typearray = [];
 d3.csv("visualization/new.csv", function(dataCSV){
   // console.log(dataCSV)
   // d3.csv("data - Copy - Copy.csv", function(dataCSV){
   // delete dataCSV['2D First'];
   // delete dataCSV['Order']

   // console.log(JSON.stringify(dataCSV))
   // console.log(dataCSV)
   var Participant = dataCSV['Sketchnotes']   
   var arrayCoding = [];
   for (var property in dataCSV){
      if (dataCSV[property] == "" || dataCSV[property] == "?"){
         delete dataCSV[property]
      } else if (dataCSV[property] == "x" ){
         arrayCoding.push(property);
         delete dataCSV[property]
      }
      
   }

   // console.log(Participant)

   for (var coding in arrayCoding){
   //    console.log(arrayCoding, coding)
      var objectToCreate = JSON.parse(JSON.stringify(dataCSV));
      var concat = arrayCoding[coding]//+'_'+objectToCreate['Condition'].split('-')[0]


        
      if (idArray[concat] != undefined) {
         idArray[concat]++;
      }
      else {
         idArray[concat] = 1;
         globalArray[concat] = []
      }


      objectToCreate['type'] = arrayCoding[coding];
      // objectToCreate['concat'] = concat;
      objectToCreate['id_'] = idArray[concat];
   //    // objectToCreate['Condition'] = 0//objectToCreate['Condition'].split('-')[0];
      objectToCreate['part'] = parseInt(objectToCreate['Sketchnotes'])

      
   //    // // data_.push(objectToCreate);
      globalArray[concat].push(objectToCreate)


      objectToCreate['Sketchnotes'] = parseInt(objectToCreate['Sketchnotes'])
      // if (typearray.indexOf(arrayCoding[coding]) == -1) typearray.push(arrayCoding[coding]);

   }
}).then(()=>{
   console.log(globalArray)

   // console.log('HELLO', globalArray)
   for (var i in globalArray){

      var array = globalArray[i];
      // console.log(i)

      var arraySorted = array.sort(function(a, b) {
         return a.part - b.part;
     });
     for (var k = 0; k<arraySorted.length; k++){
         // console.log(k)
         arraySorted[k]['id_'] = k+1;
      }

     data_ = data_.concat(arraySorted)
   //   j++
   //   break;
   //   console.log(arraySorted)
   }
   // console.log(globalArray)

   launchViz(data_);
   console.log('HELLO', data_)
});
// launchViz(data);
function launchViz(data){

   
  





   data.sort(function(a, b) {
      return d3.ascending(a.type, b.type)
   })
      // set the dimensions and margins of the graph
      var margin = {top: 20, right: 20, bottom: 30, left: 450},
         width = 4500 - margin.left - margin.right,
         height = 1100 - margin.top - margin.bottom;

      // set the ranges
      var x = d3.scaleLinear()
               .range([0, width])
               
      var y = d3.scaleBand()
               .range([height, 0])
               .padding(0.001)
               


      // var colorParticipant = d3.scaleOrdinal(d3.schemeSet3);
      var colorParticipant  = d3.scaleLinear();

      // append the svg object to the body of the page
      // append a 'group' element to 'svg'
      // moves the 'group' element to the top left margin
      var svg = d3.select("#resultsGraph").append("svg")
         .attr("width", width + margin.left + margin.right)
         .attr("height", height + margin.top + margin.bottom)
      .append("g")
         .attr("transform", 
               "translate(" + margin.left + "," + margin.top + ")");



      var max = width;  
      var minX = -320

      addBG(svg, minX, max,0, 300, 'red');   
      addBG(svg, minX, max,300, 240, 'green');     
      addBG(svg, minX, max,540, 120, 'blue');     
      addBG(svg, minX, max,660, 120, 'red'); 
      addBG(svg, minX, max,780, 270, 'green'); 
      // addBG(svg, max,300, 180, 'red');      

      // var path = makeCurlyBrace(100, 100, 100, 400, 1, 1)
      var X = -190
      appendBracket(svg, X, 0, X, 150, 'Color', 10, 0.6);
      appendBracket(svg, X, 150, X, 240, 'Font', 5, 0.6)
      appendBracket(svg, X, 240, X, 300, 'Border', 5, 0.6)
      appendBracket(svg, X, 300, X, 360, 'Separator', 5, 0.6)

      appendBracket(svg, X, 360, X, 470, 'Grouping', 5, 0.6)
      appendBracket(svg, X, 470, X, 540, 'Connector', 5, 0.6)

      appendBracket(svg, X, 540, X, 660, 'Layout', 5, 0.6)
      appendBracket(svg, X, 660, X, 780, 'Digital/Analog', 5, 0.6)
      appendBracket(svg, X, 780, X, 900, 'Text', 5, 0.6)
      appendBracket(svg, X, 900, X, 1050, 'Image', 5, 0.6)


      var X = -320
      appendBracket(svg, X, 0, X, 300, 'Visual Style', 10, 0.6)
      appendBracket(svg, X, 300, X, 540, 'Structure', 10, 0.6)
      appendBracket(svg, X, 540, X, 660, 'Layout', 10, 0.6)
      appendBracket(svg, X, 660, X, 780, 'Digital/Analog', 10, 0.6)
      appendBracket(svg, X, 780, X, 1050, 'Content', 10, 0.6)
      // get the data

      //   if (error) throw error;

      // format the data

      // Scale the range of the data in the domains
      y.domain(data.map(function(d) { return d.type; }));

      // var scaleX = d3.scaleLinea();

      // append the rectangles for the bar chart
      var place = svg.selectAll(".bar")
            .data(data)
            .enter().append('g').attr('class', 'bar')
            .style('cursor', 'pointer')
            .attr("transform", function(d) {
               // console.log(y(d.type))
               return "translate(-15, " +  (y(d.type)+5)+")"; 
            })
            .on("click", function(d) {	
               console.log()
               var urlConcat = "http://" + URLlink[d.Sketchnotes-1]
               var win = window.open(urlConcat, '_blank');
            })
            // .on("mouseover", function(d) {	
               
            //    // console.log(d)
            //    var BB = d3.select(this).node().getBoundingClientRect();
            //    // console.log(BB)
            //    div.transition()		
            //       .duration(0)		
            //       .style("opacity", 1);		
            //    // div.html(d.Sketchnotes)	
            //    //    .style("left", (BB.x +10) + "px")		
            //    //    .style("top", (window.scrollY + BB.y - 35) + "px");
            //    // console.log('<img src=Viz/image '+d.Sketchnotes+'.jpg>')	
            //    // div.html('<img src="visualization/Viz/image ('+d.part+').png">')
            //    div.html('<img src="visualization/Viz/image ('+d.part+').png">')	
            //       .style("left", (BB.x + 50) + "px")		
            //       .style("width", "400px")		
            //       .style("top", (window.scrollY + BB.y - 35) + "px");	
            //    })					
            //    .on("mouseout", function(d) {		
            //          div.transition()		
            //             .duration(0)		
            //             .style("opacity", 0);	
            //    });


         // MY BAR ==> GROUP OF BARS
            var g = place.append('g')
            .attr("transform", function(d) {
               // if (d.type == "Personal - Making it personal" && d.Condition == "VR") console.log(d)

               var y = 0//y1(d.Condition);
               var x = (Math.ceil (d.id_));
               var y2 = (d.id_ - x) * 25; 
               return "translate("+(x*30)+","+(y2)+")"; 
            
            })
            
         g.append("rect")
            .attr("class", "bar")
            // .attr("x", -1)
            .attr("width", 25)
            // .attr("y", -2)
            .attr("height", 25)
            // .attr("fill",function(d,i){ 
            //    if (d.part == 13) return 'red'
            // })
            .attr('stroke', 'black')
            .attr("fill",function(d,i){ 
               // if (d.type == "Personal - Making it personal" && d.id_ == 1) return 'red'
               // else  
               return 'white';//colorParticipant(d.part) 
            });//console.log(dParticipant)})

         // g.append('text')
         // .text(function(d){
         //    return '#' + d.part
         // })
         // .attr('dy', 15)
         // .attr('dx', 15)
         // .attr('text-anchor', 'middle')
         g.append("image")
            .attr('x', 0)
            .attr('y', 0)
            .attr('width', 25)
            .attr('height', 25)
            .attr('class', 'imageThumbnail')
            .attr("xlink:href", function(d,i){
               // return  "visualization/images/avatar.png";
               // return  "visualization/Viz/image ("+d.part+")Cropped.jpg";
               return  "visualization/Viz/image ("+ d.part +").png";
            })

         g.append("rect")
            .attr("class", "bar")
            .attr("width", 25)
            .attr("height", 25)
            .attr('stroke', 'black')
            .attr("fill", 'none');
            


svg.append("g").call(d3.axisLeft(y));

// console.log(d3.axisLeft(y))

      var div = d3.select("body").append("div")	
            .attr("class", "tooltip")				
            .style("opacity", 0);



        

};
function appendBracket(svg, x1, y1, x2, y2, txt, p1, p2){
   bracket = svg.append("path").attr("class","curlyBrace");
   bracket.attr("d", function(d) { return makeCurlyBrace(x1, y1+5, x2, y2-5, p1, p2); });
   bracket.attr('fill', 'none')
   bracket.attr('stroke-width', '2px')
   bracket.attr('stroke', 'black')

   svg.append("text")
   .attr('dx', (x1+x2)/2 - 20)
   .attr('dy', (y1+y2)/2 + 5)
   .attr('text-anchor', 'end')
   .text(txt)
}
function addBG(svg, minX, max, where, height, color){
   var redBox = svg.append("rect")
   .attr("x", minX)
   .attr("y", where)
   .attr("width", max)
   .attr("height", height)
   .attr("fill", color)
   .attr("opacity", 0.1);
}

function makeCurlyBrace(x1,y1,x2,y2,w,q){
			//Calculate unit vector
			var dx = x1-x2;
			var dy = y1-y2;
			var len = Math.sqrt(dx*dx + dy*dy);
			dx = dx / len;
			dy = dy / len;

			//Calculate Control Points of path,
			var qx1 = x1 + q*w*dy;
			var qy1 = y1 - q*w*dx;
			var qx2 = (x1 - .25*len*dx) + (1-q)*w*dy;
			var qy2 = (y1 - .25*len*dy) - (1-q)*w*dx;
			var tx1 = (x1 -  .5*len*dx) + w*dy;
			var ty1 = (y1 -  .5*len*dy) - w*dx;
			var qx3 = x2 + q*w*dy;
			var qy3 = y2 - q*w*dx;
			var qx4 = (x1 - .75*len*dx) + (1-q)*w*dy;
			var qy4 = (y1 - .75*len*dy) - (1-q)*w*dx;

    	return ( "M " +  x1 + " " +  y1 +
         		" Q " + qx1 + " " + qy1 + " " + qx2 + " " + qy2 + 
          		" T " + tx1 + " " + ty1 +
          		" M " +  x2 + " " +  y2 +
          		" Q " + qx3 + " " + qy3 + " " + qx4 + " " + qy4 + 
          		" T " + tx1 + " " + ty1 );
		}